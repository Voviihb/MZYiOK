     1                                  %include "lib.asm"
     2                              <1> StrToInt:
     3 00000000 57                  <1> push edi
     4 00000001 B739                <1> mov bh,'9'
     5 00000003 B330                <1> mov bl,'0'
     6 00000005 56                  <1> push esi ; сохраняем адрес исходной строки
     7 00000006 803E2D              <1> cmp byte[esi], '-'
     8 00000009 7501                <1> jne .prod
     9 0000000B 46                  <1> inc esi ; пропускаем знак минус
    10 0000000C FC                  <1> .prod cld
    11 0000000D 6631FF              <1> xor di,di ; обнуляем будущее число
    12 00000010 AC                  <1> .cycle: lodsb ; загружаем символ (цифру)
    13 00000011 3C0A                <1> cmp al,10 ; если 10, то на конец
    14 00000013 741F                <1> je .Return
    15 00000015 38D8                <1> cmp al,bl ; сравниваем с кодом нуля
    16 00000017 722F                <1> jb .Error ; "ниже" – Ошибка
    17 00000019 38F8                <1> cmp al,bh ; сравниваем с кодом девяти
    18 0000001B 772B                <1> ja .Error ; "выше" – Ошибка
    19 0000001D 2C30                <1> sub al,30h ; получаем цифру из символа
    20 0000001F 6698                <1> cbw ; расширяем до слова
    21 00000021 6650                <1> push ax ; сохраняем в стеке
    22 00000023 66B80A00            <1> mov ax,10 ; заносим 10 в AX
    23 00000027 66F7E7              <1> mul di ; умножаем, результат в DX:AX
    24 0000002A 665F                <1> pop di ; в DI – очередная цифра
    25 0000002C 6601F8              <1> add ax,di
    26 0000002F 6689C7              <1> mov di,ax ; в DI – накопленное число
    27 00000032 EBDC                <1> jmp .cycle
    28 00000034 5E                  <1> .Return: pop esi
    29 00000035 BB00000000          <1> mov ebx,0
    30 0000003A 803E2D              <1> cmp byte[esi],'-'
    31 0000003D 7503                <1> jne .J
    32 0000003F 66F7DF              <1> neg di
    33 00000042 6689F8              <1> .J mov ax,di
    34 00000045 98                  <1> cwde
    35 00000046 EB0B                <1> jmp .R
    36 00000048 5E                  <1> .Error: pop esi
    37 00000049 B800000000          <1> mov eax,0
    38 0000004E BB01000000          <1> mov ebx,1
    39 00000053 5F                  <1> .R pop EDI
    40 00000054 C3                  <1> ret
    41                              <1> 
    42                              <1> 
    43                              <1> 
    44                              <1> IntToStr:
    45 00000055 57                  <1> push edi
    46 00000056 53                  <1> push ebx
    47 00000057 52                  <1> push edx
    48 00000058 51                  <1> push ecx
    49 00000059 56                  <1> push esi
    50 0000005A C60600              <1> mov byte[esi],0 ; на место знака
    51 0000005D 83F800              <1> cmp eax,0
    52 00000060 7D05                <1> jge .l1
    53 00000062 F7D8                <1> neg eax
    54 00000064 C6062D              <1> mov byte[esi],'-'
    55 00000067 C646060A            <1> .l1 mov byte[esi+6],10
    56 0000006B BF05000000          <1> mov edi,5
    57 00000070 66BB0A00            <1> mov bx,10
    58 00000074 6699                <1> .again: cwd ; расширили слово до двойного
    59 00000076 66F7F3              <1> div bx ; делим результат на 10
    60 00000079 80C230              <1> add dl,30h ; получаем из остатка код цифры
    61 0000007C 88143E              <1> mov [esi+edi],DL ; пишем символ в строку
    62 0000007F 4F                  <1> dec edi ; переводим указатель на
    63                              <1> ; предыдущую позицию
    64 00000080 6683F800            <1> cmp ax, 0 ; преобразовали все число?
    65 00000084 75EE                <1> jne .again
    66 00000086 B806000000          <1> mov eax, 6
    67 0000008B 29F9                <1> sub ecx, edi ; длина результата+знак
    68 0000008D 89C8                <1> mov eax,ecx
    69 0000008F 40                  <1> inc eax ; длина результата+знак+0А
    70 00000090 46                  <1> inc esi ; пропускаем знак
    71 00000091 56                  <1> push esi
    72 00000092 8D343E              <1> lea esi,[esi+edi] ; начало символов результата
    73 00000095 5F                  <1> pop edi
    74                              <1> ;rep movsb
    75 00000096 5E                  <1> pop esi
    76 00000097 59                  <1> pop ecx
    77 00000098 5A                  <1> pop edx
    78 00000099 5B                  <1> pop ebx
    79 0000009A 5F                  <1> pop edi
    80 0000009B C3                  <1> ret
     2                                  
     3                                  section .data ; сегмент инициализированных переменных
     4 00000000 010000000200000003-     matrix dd 1, 2, 3, 4, 5, 6, 7
     4 00000009 000000040000000500-
     4 00000012 000006000000070000-
     4 0000001B 00                 
     5 0000001C 0200000000000000F9-            dd 2, 0, -7, 5, 9, 7, 1
     5 00000025 FFFFFF050000000900-
     5 0000002E 000007000000010000-
     5 00000037 00                 
     6 00000038 0700000009000000FC-            dd 7, 9, -4, -2, 0, -3, 5
     6 00000041 FFFFFFFEFFFFFF0000-
     6 0000004A 0000FDFFFFFF050000-
     6 00000053 00                 
     7 00000054 F7FFFFFFFBFFFFFF0B-            dd -9, -5, 11, 5, 44, 0, 1
     7 0000005D 000000050000002C00-
     7 00000066 000000000000010000-
     7 0000006F 00                 
     8 00000070 000000000100000002-            dd 0, 1, 2, 3, 4, 5, 6
     8 00000079 000000030000000400-
     8 00000082 000005000000060000-
     8 0000008B 00                 
     9 0000008C 000000000000000000-            dd 0, 0, 0, 0, 0, 0, 0
     9 00000095 000000000000000000-
     9 0000009E 000000000000000000-
     9 000000A7 00                 
    10 000000A8 070000000600000005-            dd 7, 6, 5, 4, 3, 2, 1
    10 000000B1 000000040000000300-
    10 000000BA 000002000000010000-
    10 000000C3 00                 
    11                                  
    12                                  section .bss ; сегмент неинициализированных переменных
    13 00000000 <res Ah>                inBuf resb 10 ; буфер для вводимой строки
    14                                  lenIn equ $-inBuf
    15                                  
    16 0000000A ??????????????          outBuf resb 7
    17                                  lenOut equ $-outBuf
    18                                  
    19 00000011 <res 1Ch>               H resd 7
    20                                  
    21                                  section .text ; сегмент кода
    22                                  global _start
    23                                  _start:
    24                                  
    25                                  process:
    26 0000009C B907000000                  mov ECX, 7 ; count of operations needed
    27 000000A1 BB00000000                  mov EBX, 0 ; current H pos
    28 000000A6 BE00000000                  mov ESI, 0 ; pos1 for main diagonal
    29 000000AB BF06000000                  mov EDI, 6 ; pos2 for addintional diagonal
    30                                  cycle:
    31 000000B0 8B04B5[00000000]            mov EAX, [matrix+ESI*4]
    32 000000B7 F72CBD[00000000]            imul DWORD[matrix+EDI*4]
    33 000000BE 89049D[11000000]            mov [H+EBX*4], EAX
    34 000000C5 83C608                      add ESI, 8
    35 000000C8 83C706                      add EDI, 6
    36 000000CB 43                          inc EBX
    37 000000CC E2E2                        loop cycle
    38                                      
    39                                  finalize:
    40 000000CE B907000000                mov ECX, 7 ; total elements
    41 000000D3 BB00000000                mov EBX, 0 ; start pos
    42                                  output:
    43 000000D8 51                          push ECX
    44                                      ; очищаем буфер после вывода
    45 000000D9 B907000000                  mov ECX, 7 ; длина буфера вывода
    46 000000DE B000                        mov Al, 0
    47 000000E0 FC                          cld ; сброс флага направления
    48 000000E1 8D3D[0A000000]              lea EDI, [outBuf] ; забиваем нулями
    49 000000E7 F3AA                        rep stosb
    50 000000E9 59                          pop ECX
    51                                  
    52 000000EA BE[0A000000]                mov ESI, outBuf ; output addr
    53 000000EF 8B049D[11000000]            mov EAX, [H+EBX*4] ; to be converted to string
    54 000000F6 51                          push ECX ; save data
    55 000000F7 53                          push EBX
    56 000000F8 E858FFFFFF                  call IntToStr
    57 000000FD B804000000                  mov eax, 4 ; системная функция 4 (write)
    58 00000102 BB01000000                  mov ebx, 1 ; дескриптор файла stdout=1
    59 00000107 B9[0A000000]                mov ecx, outBuf ; адрес выводимой строки
    60 0000010C BA07000000                  mov edx, lenOut ; длина выводимой строки
    61 00000111 CD80                        int 80h ; вызов системной функции
    62                                      
    63 00000113 5B                          pop EBX
    64 00000114 59                          pop ECX
    65 00000115 43                          inc EBX ; pos = pos + 1
    66 00000116 E2C0                        loop output
    67                                    
    68                                  exit:
    69 00000118 B801000000                  mov eax, 1 ; системная функция 1 (exit)
    70 0000011D 31DB                        xor ebx, ebx ; код возврата 0
    71 0000011F CD80                        int 80h ; вызов системной функции
